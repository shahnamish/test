# Fluentd configuration for centralized logging

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type tail
  path /var/log/application/*.log
  pos_file /var/log/td-agent/application.log.pos
  tag application.*
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

<source>
  @type tail
  path /var/log/audit/*.log
  pos_file /var/log/td-agent/audit.log.pos
  tag audit.*
  <parse>
    @type regexp
    expression /^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) \| (?<level>[A-Z]+) \| (?<event_type>[^ ]+) \| (?<user_id>[^ ]+) \| (?<action>[^ ]+) \| (?<resource>[^ ]+) \| (?<result>[^ ]+) \| (?<metadata>.*)$/
    time_key timestamp
    time_format %Y-%m-%d %H:%M:%S,%N
  </parse>
</source>

<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    environment "#{ENV['APP_ENV'] || 'production'}"
  </record>
</filter>

<filter audit.**>
  @type grep
  <exclude>
    key level
    pattern /^DEBUG$/
  </exclude>
</filter>

<match audit.**>
  @type copy
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix audit
    logstash_dateformat %Y.%m.%d
    include_tag_key true
    type_name _doc
    tag_key @log_name
    <buffer>
      flush_interval 5s
      retry_max_times 10
      retry_wait 10s
    </buffer>
  </store>
  <store>
    @type s3
    aws_key_id "#{ENV['AWS_ACCESS_KEY_ID']}"
    aws_sec_key "#{ENV['AWS_SECRET_ACCESS_KEY']}"
    s3_bucket audit-logs
    s3_region us-east-1
    path logs/%Y/%m/%d/
    <buffer time>
      @type file
      path /var/log/td-agent/s3
      timekey 3600
      timekey_wait 10m
      timekey_use_utc true
    </buffer>
  </store>
</match>

<match application.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  logstash_format true
  logstash_prefix application
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  type_name _doc
  <buffer>
    flush_interval 5s
  </buffer>
</match>

<match **>
  @type stdout
</match>
